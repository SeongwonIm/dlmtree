---
title: "TDLMM"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TDLMM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette demonstrates the implementation of treed distributed lag mixture model (TDLMM). More details can be found in Mork and Wilson (2023) <doi: [10.1111/biom.13568](https://doi.org/10.1111/biom.13568)>.

```{r setup}
library(dlmtree)
set.seed(1)
```

### Fitting the model
```{r tdlmm.fit}
D <- sim.tdlmm(sim = "B", n = 5000)
fit <- dlmtree(formula = y ~ .,
               data = D$dat,
               exposure.data = D$exposures,
               dlm.type = "linear", 
               mixture = TRUE,
               binomial.size = 1,
               mixture.interactions = "noself",
               n.burn = 2500, n.iter = 10000, n.thin = 5)
```

### Model fit summary
```{r tdlmm.sum}
fit_sum <- summary(fit)
fit_sum
```

### Main exposure effect
```{r tdlmm.plot}
plot(fit_sum, 
     exposure1 = "e1", 
     main = "Plot title", 
     xlab = "Time axis label",
     ylab = "Exposure effect axis label")
```

### Lagged interaction effect
```{r}
plot(fit_sum, 
     exposure1 = "e1",      # Specify first exposure
     exposure2 = "e2",      # Specify second exposure 
     main = "Plot title")
```

### Adjusting for expected changes in co-occurring exposures
Here we consider going from the 25th to the 75th percentile in each exposure while adjusting for the expected changes in other exposures due to their correlations with the exposure of interest.
```{r}
library(ggplot2)
dlm_coexp <- adj_coexposure(D$exposures, fit, contrast_perc = c(0.25, 0.75))
ggplot(dlm_coexp, aes(x = Time, y = Effect, ymin = Lower, ymax = Upper)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_ribbon(fill = "grey") +
  geom_line() +
  facet_wrap(~Name) +
  theme_bw()
```
